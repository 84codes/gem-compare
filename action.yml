name: "Gem Compare"
description: "Compare different gem versions"
branding:
  icon: "search"
  color: "red"
inputs:
  gem_compare_version:
    description: 'Version of the gem-compare plugin'
    default: '1.1.0'
    required: false
  name:
    description: 'Name of gem to compare'
    required: true
  from:
    description: 'From version'
    required: true
  to:
    description: 'To version'
    required: true
  github-token:
    description: "The repo scoped token generated by GitHub Actions"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1

    - name: Run gem install gem-compare
      shell: bash
      run: |
        gem install gem-compare --version ${{ inputs.gem_compare_version }}

    - name: Run gem compare
      shell: bash
      env:
        COMPARE_GEM: ${{ inputs.name }}
        COMPARE_FROM_VERSION: ${{ inputs.from }}
        COMPARE_TO_VERSION: ${{ inputs.to }}
      run: |
        gem compare $COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION > compare_output.txt

    - name: Run gem compare --diff
      shell: bash
      env:
        COMPARE_GEM: ${{ inputs.name }}
        COMPARE_FROM_VERSION: ${{ inputs.from }}
        COMPARE_TO_VERSION: ${{ inputs.to }}
      run: |
        gem compare --diff $COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION > compare_diff.txt

    - name: Run gh pr comment
      shell: bash
      env:
        COMPARE_GEM: ${{ inputs.name }}
        COMPARE_FROM_VERSION: ${{ inputs.from }}
        COMPARE_TO_VERSION: ${{ inputs.to }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        echo "## <code>gem compare $COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION</code>" > comment.txt
        echo ''                        >> comment.txt
        echo '````ruby'                >> comment.txt
        cat compare_output.txt         >> comment.txt
        echo '````'                    >> comment.txt
        echo ''                        >> comment.txt
        echo "<Details><Summary><h2><code>gem compare --diff"\
             "$COMPARE_GEM $COMPARE_FROM_VERSION $COMPARE_TO_VERSION</code></h2></Summary>" >> comment.txt
        echo ''                        >> comment.txt
        echo '````ruby'                >> comment.txt
        cat compare_diff.txt           >> comment.txt
        echo '````'                    >> comment.txt
        echo '</Details>'              >> comment.txt

        gh pr comment 1 --body-file comment.txt
